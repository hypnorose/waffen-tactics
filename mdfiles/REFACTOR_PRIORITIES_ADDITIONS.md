# Refactor Priorities — Supplementary Notes

Date: 2025-12-23

This file contains short, actionable notes added after an automated scan. It supplements `REFACTOR_PRIORITIES.md` and `priorities2.md`.

Files flagged for splitting / modularization:
- `waffen-tactics/src/waffen_tactics/services/event_canonicalizer.py` — split into `emitters/payload.py`, `emitters/mutators.py`, `emitters/canonical.py`.
- `waffen-tactics/src/waffen_tactics/services/combat_simulator.py` — extract dispatcher bootstrap into `engine/event_dispatcher.py`; move HP/snapshot logic to `engine/combat_state.py`.
- `waffen-tactics/src/waffen_tactics/services/combat_attack_processor.py` — split to `processors/attack.py` with `compute` and `apply` phases.

Antipatterns detected (concise):
- Duplicate authoritative state (unit vs hp lists).
- Emitters that both mutate and return payloads.
- Caller-string guards (`_set_mana(caller_module)`) in `CombatUnit`.
- Multiple ad-hoc dispatcher emit assignments instead of single-injection.

Next recommended small tasks:
1. Create `engine/event_dispatcher.py` and write 2-3 unit tests covering seq advancement and dropped-callback behavior.
2. Add `# TODO: REFACTOR` annotations to the top of flagged files to mark them for future PRs.
3. Create `engine/combat_state.py` to encapsulate HP lists and provide `get_snapshot()`.

---
Generated by automated repo scan.
