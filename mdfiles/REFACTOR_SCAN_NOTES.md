# Refactor Scan Notes (automated)

Date: 2025-12-23

Summary:
- Quick automated scan found multiple coupling and anti-patterns in core combat files. These notes capture concrete file-split candidates and short actionable recommendations to include in the main refactor doc.

Key findings:
- Duplication of authoritative state:
  - `CombatSimulator` and processors rely on both `unit.hp`/`unit.mana` and separate HP lists (`a_hp`, `b_hp`) synchronized in multiple places.
  - Risk: desyncs, ordering-dependant bugs (observed in failing seed runs).

- Emission + mutation mixing:
  - `event_canonicalizer.py` builds payloads and mutates units. Separate builders from mutators to enable pure replay and easier unit tests.

- Dispatcher responsibilities scattered:
  - Sequencing/timestamp normalization logic exists in wrapper functions and an `EventDispatcher`-like class; centralize into `engine/event_dispatcher.py` and inject into processors.

- Test-suite assumptions:
  - Several tests referenced legacy `attack` events; canonical `unit_attack` is enforced in tests now. Keep reconstructor and client code strict to avoid regressions.

Immediate file-split suggestions (first-pass):
- `waffen-tactics/src/waffen_tactics/services/event_canonicalizer.py` →
  - `emitters/payload.py` (pure payload builders)
  - `emitters/mutators.py` (apply to UnitState)
  - `emitters/canonical.py` (thin facade combining payload+mutator)

- `waffen-tactics/src/waffen_tactics/services/combat_simulator.py` →
  - Move event wrapping into `engine/event_dispatcher.py`
  - Move HP list and snapshot logic into `engine/combat_state.py`

- `waffen-tactics/src/waffen_tactics/services/combat_attack_processor.py` →
  - `processors/attack.py` with `compute_attacks(state)` → returns events and `apply_attacks(events, state, dispatcher)` → mutates and emits

Non-ideal code patterns to fix early:
- `_set_mana(caller_module)` guard in `CombatUnit` — replace with `set_mana()` and limit who calls it via code review.
- Multiple call sites doing `dispatcher.emit = wrapped_callback` — replace with single injected `EventDispatcher` instance.

Next steps I can take (pick one):
- Add inline `# TODO: REFACTOR` comments to flagged source files and create a small PR for `event_dispatcher` extraction.
- Implement `engine/event_dispatcher.py` (Option A from main doc) with tests.

---
Generated by automation during refactor review.
